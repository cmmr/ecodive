# R-hub's generic GitHub Actions workflow file. It's canonical location is at
# https://github.com/r-hub/actions/blob/v1/workflows/rhub.yaml
# You can update this file to a newer version using the rhub2 package:
#
# rhub::rhub_setup()
#
# It is unlikely that you need to modify this file manually.

name: R-hub
run-name: "${{ github.event.inputs.id }}: ${{ github.event.inputs.name || format('Manually run by {0}', github.triggering_actor) }}"

on:
  workflow_dispatch:
    inputs:
      config:
        description: 'A comma separated list of R-hub platforms to use.'
        type: string
        default: 'linux,windows,macos'
      name:
        description: 'Run name. You can leave this empty now.'
        type: string
      id:
        description: 'Unique ID. You can leave this empty now.'
        type: string

jobs:

  setup:
    runs-on: ubuntu-latest
    outputs:
      containers: ${{ steps.rhub-setup.outputs.containers }}
      platforms: ${{ steps.rhub-setup.outputs.platforms }}

    steps:
    # NO NEED TO CHECKOUT HERE
    - uses: r-hub/actions/setup@v1
      with:
        config: ${{ github.event.inputs.config }}
      id: rhub-setup

  linux-containers:

    needs: setup
    if: ${{ needs.setup.outputs.containers != '[]' }}
    runs-on: ubuntu-latest
    name: ${{ matrix.config.label }}
    strategy:
      fail-fast: false
      matrix:
        config: ${{ fromJson(needs.setup.outputs.containers) }}
    container:
      image: ${{ matrix.config.container }}

    steps:
      - uses: r-hub/actions/checkout@v1
      
      - uses: r-hub/actions/platform-info@v1
        with:
          token: ${{ secrets.RHUB_TOKEN }}
          job-config: ${{ matrix.config.job-config }}

      - uses: r-hub/actions/setup-deps@v1
        with:
          token: ${{ secrets.RHUB_TOKEN }}
          job-config: ${{ matrix.config.job-config }}

      - uses: r-hub/actions/run-check@v1
        with:
          token: ${{ secrets.RHUB_TOKEN }}
          job-config: ${{ matrix.config.job-config }}

      - name: Verify rchk results (Enhanced)
        if: ${{ always() && matrix.config.label == 'rchk' }}
        shell: Rscript {0}
        run: |
          # Define paths
          pkg           <- read.dcf("DESCRIPTION", "Package")[[1]]
          libs_dir      <- file.path("/opt/R/devel-rchk/packages/lib", pkg, "libs")
          so_file       <- file.path(libs_dir, paste0(pkg, ".so"))
          bc_file       <- file.path(libs_dir, paste0(pkg, ".so.bc"))
          bcheck_file   <- file.path(libs_dir, paste0(pkg, ".so.bcheck"))
          maacheck_file <- file.path(libs_dir, paste0(pkg, ".so.maacheck"))

          # --- HELPER: Find executable ---
          find_exec <- function(name) {
            path <- Sys.which(name)
            if (path == "") {
              # Common locations in rchk images
              candidates <- system(paste("find /rchk /opt /usr -name", name, "-type f -executable 2>/dev/null"), intern = TRUE)
              if (length(candidates) > 0) path <- candidates[1]
            }
            return(path)
          }

          # --- 1. GENERATE BITCODE (.bc) ---
          if (file.exists(so_file)) {
            if (!file.exists(bc_file)) {
              cat("Bitcode file not found. Attempting to extract from .so...\n")
              extract_bc <- find_exec("extract-bc")
              
              if (length(extract_bc) > 0 && extract_bc != "") {
                cmd <- paste(extract_bc, shQuote(so_file))
                cat("Running:", cmd, "\n")
                if (system(cmd) == 0) {
                  cat("Successfully extracted bitcode to:", bc_file, "\n")
                } else {
                  cat("Error: extract-bc failed.\n")
                }
              } else {
                cat("Error: 'extract-bc' tool not found.\n")
              }
            }
          } else {
            stop("Could not find shared object file at: ", so_file)
          }

          # --- 2. RUN MAACHECK ---
          if (file.exists(bc_file)) {
            maacheck_bin <- find_exec("maacheck")
            
            if (length(maacheck_bin) > 0 && maacheck_bin != "") {
                cat("Running maacheck on", bc_file, "\n")
                # Run maacheck on the .bc file
                cmd <- paste(maacheck_bin, shQuote(bc_file), ">", shQuote(maacheck_file), "2>&1")
                system(cmd)
            } else {
                cat("Error: Could not find 'maacheck' executable.\n")
            }
          } else {
            cat("Skipping maacheck: .bc file could not be produced.\n")
          }

          # --- 3. VERIFY RESULTS ---
          errors <- character(0)

          # Check bcheck
          if (file.exists(bcheck_file)) {
            b_lines <- readLines(bcheck_file)
            b_lines <- b_lines[!grepl("too many states", b_lines)]
            b_lines <- b_lines[!grepl("^Analyzed [0-9]+ functions", b_lines)]
            b_lines <- b_lines[!grepl("^==== rchk bcheck", b_lines)]
            if (length(b_lines) > 0) {
               cat("Found bcheck errors:\n")
               print(b_lines)
               errors <- c(errors, b_lines)
            }
          }

          # Check maacheck
          if (file.exists(maacheck_file)) {
            m_lines <- readLines(maacheck_file)
            # Filter common maacheck info/headers if necessary
            m_lines <- m_lines[!grepl("INFO:", m_lines)] 
            if (length(m_lines) > 0) {
               cat("Found maacheck output:\n")
               print(m_lines)
               errors <- c(errors, m_lines)
            }
          }

          # Fail if errors exist
          errors <- errors[nzchar(errors)]
          if (length(errors) > 0) {
            stop("rchk failed! Errors detected:\n", paste(errors, collapse = "\n"))
          } else {
            cat("SUCCESS: No memory protection errors found by rchk.\n")
          }

      - name: Show install log
        if: always()
        run: find . -name '00install.out' -exec cat {} +
        shell: bash


  other-platforms:

    needs: setup
    if: ${{ needs.setup.outputs.platforms != '[]' }}
    runs-on: ${{ matrix.config.os }}
    name: ${{ matrix.config.label }}
    strategy:
      fail-fast: false
      matrix:
        config: ${{ fromJson(needs.setup.outputs.platforms) }}

    steps:
      - uses: r-hub/actions/checkout@v1

      - uses: r-hub/actions/setup-r@v1
        with:
          job-config: ${{ matrix.config.job-config }}
          token: ${{ secrets.RHUB_TOKEN }}

      - uses: r-hub/actions/platform-info@v1
        with:
          token: ${{ secrets.RHUB_TOKEN }}
          job-config: ${{ matrix.config.job-config }}

      - uses: r-hub/actions/setup-deps@v1
        with:
          job-config: ${{ matrix.config.job-config }}
          token: ${{ secrets.RHUB_TOKEN }}

      - uses: r-hub/actions/run-check@v1
        with:
          job-config: ${{ matrix.config.job-config }}
          token: ${{ secrets.RHUB_TOKEN }}

      - name: Show install log
        if: always()
        run: find . -name '00install.out' -exec cat {} +
        shell: bash
