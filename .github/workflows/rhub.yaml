# R-hub's generic GitHub Actions workflow file. It's canonical location is at
# https://github.com/r-hub/actions/blob/v1/workflows/rhub.yaml
# You can update this file to a newer version using the rhub2 package:
#
# rhub::rhub_setup()
#
# It is unlikely that you need to modify this file manually.

name: R-hub
run-name: "${{ github.event.inputs.id }}: ${{ github.event.inputs.name || format('Manually run by {0}', github.triggering_actor) }}"

on:
  workflow_dispatch:
    inputs:
      config:
        description: 'A comma separated list of R-hub platforms to use.'
        type: string
        default: 'linux,windows,macos'
      name:
        description: 'Run name. You can leave this empty now.'
        type: string
      id:
        description: 'Unique ID. You can leave this empty now.'
        type: string

jobs:

  setup:
    runs-on: ubuntu-latest
    outputs:
      containers: ${{ steps.rhub-setup.outputs.containers }}
      platforms: ${{ steps.rhub-setup.outputs.platforms }}

    steps:
    # NO NEED TO CHECKOUT HERE
    - uses: r-hub/actions/setup@v1
      with:
        config: ${{ github.event.inputs.config }}
      id: rhub-setup

  linux-containers:

    needs: setup
    if: ${{ needs.setup.outputs.containers != '[]' }}
    runs-on: ubuntu-latest
    name: ${{ matrix.config.label }}
    strategy:
      fail-fast: false
      matrix:
        config: ${{ fromJson(needs.setup.outputs.containers) }}
    container:
      image: ${{ matrix.config.container }}

    steps:
      - uses: r-hub/actions/checkout@v1
      
      - uses: r-hub/actions/platform-info@v1
        with:
          token: ${{ secrets.RHUB_TOKEN }}
          job-config: ${{ matrix.config.job-config }}

      - uses: r-hub/actions/setup-deps@v1
        with:
          token: ${{ secrets.RHUB_TOKEN }}
          job-config: ${{ matrix.config.job-config }}

      - uses: r-hub/actions/run-check@v1
        with:
          token: ${{ secrets.RHUB_TOKEN }}
          job-config: ${{ matrix.config.job-config }}

      - name: Verify rchk results (Enhanced)
        if: ${{ always() && matrix.config.label == 'rchk' }}
        shell: Rscript {0}
        run: |
          # --- CONFIGURATION ---
          pkg           <- read.dcf("DESCRIPTION", "Package")[[1]]
          libs_dir      <- file.path("/opt/R/devel-rchk/packages/lib", pkg, "libs")
          so_file       <- file.path(libs_dir, paste0(pkg, ".so"))
          pkg_bc_file   <- file.path(libs_dir, paste0(pkg, ".so.bc"))
          bcheck_file   <- file.path(libs_dir, paste0(pkg, ".so.bcheck"))
          maacheck_file <- file.path(libs_dir, paste0(pkg, ".so.maacheck"))
          
          # Path to R's shared library (needed for maacheck context)
          r_lib_file    <- file.path(R.home("lib"), "libR.so")
          r_bc_file     <- "libR.so.bc" # We will create this in the working dir

          # --- HELPER: Find executable ---
          find_exec <- function(name) {
            path <- Sys.which(name)
            if (path == "") {
              candidates <- system(paste("find /rchk /opt /usr -name", name, "-type f -executable 2>/dev/null"), intern = TRUE)
              if (length(candidates) > 0) path <- candidates[1]
            }
            return(path)
          }

          extract_bc <- find_exec("extract-bc")
          maacheck   <- find_exec("maacheck")

          # --- 1. PREPARE R BITCODE ---
          # We copy libR.so to the current dir to avoid permission issues in /opt
          if (file.exists(r_lib_file)) {
             file.copy(r_lib_file, "libR.so", overwrite = TRUE)
             if (file.exists("libR.so") && length(extract_bc) > 0) {
                cat("Extracting bitcode from libR.so...\n")
                system(paste(extract_bc, "libR.so"))
             }
          }
          
          if (!file.exists(r_bc_file)) {
             cat("WARNING: Could not generate libR.so.bc. maacheck will likely fail.\n")
          }

          # --- 2. PREPARE PACKAGE BITCODE ---
          if (file.exists(so_file) && length(extract_bc) > 0) {
             if (!file.exists(pkg_bc_file)) {
                cat("Extracting bitcode from package .so...\n")
                system(paste(extract_bc, shQuote(so_file)))
             }
          }

          # --- 3. RUN MAACHECK ---
          if (file.exists(pkg_bc_file) && length(maacheck) > 0) {
             # ARGUMENT ORDER MATTERS: maacheck <R_BITCODE> <PACKAGE_BITCODE>
             # If R bitcode is missing, we try running without it (will fail with R_gc_internal error, but consistent)
             args <- shQuote(pkg_bc_file)
             if (file.exists(r_bc_file)) {
                args <- paste(shQuote(r_bc_file), args)
             }
             
             cmd <- paste(maacheck, args, ">", shQuote(maacheck_file), "2>&1")
             cat("Running:", cmd, "\n")
             system(cmd)
          } else {
             cat("Skipping maacheck: Missing tools or bitcode files.\n")
          }

          # --- 4. VERIFY RESULTS ---
          errors <- character(0)

          # Check bcheck
          if (file.exists(bcheck_file)) {
            b_lines <- readLines(bcheck_file)
            b_lines <- b_lines[!grepl("too many states", b_lines)]
            b_lines <- b_lines[!grepl("^Analyzed [0-9]+ functions", b_lines)]
            b_lines <- b_lines[!grepl("^==== rchk bcheck", b_lines)]
            if (length(b_lines) > 0) {
               cat("Found bcheck errors:\n")
               print(b_lines)
               errors <- c(errors, b_lines)
            }
          }

          # Check maacheck
          if (file.exists(maacheck_file)) {
            m_lines <- readLines(maacheck_file)
            # Filter common info/headers
            m_lines <- m_lines[!grepl("INFO:", m_lines)]
            m_lines <- m_lines[!grepl("Cannot read base IR file", m_lines)] # Filter our own previous errors if any
            
            if (length(m_lines) > 0) {
               cat("Found maacheck output:\n")
               print(m_lines)
               errors <- c(errors, m_lines)
            }
          }

          if (length(errors) > 0) {
            stop("rchk failed! Errors detected")
          } else {
            cat("SUCCESS: No memory protection errors found.\n")
          }

      - name: Show install log
        if: always()
        run: find . -name '00install.out' -exec cat {} +
        shell: bash


  other-platforms:

    needs: setup
    if: ${{ needs.setup.outputs.platforms != '[]' }}
    runs-on: ${{ matrix.config.os }}
    name: ${{ matrix.config.label }}
    strategy:
      fail-fast: false
      matrix:
        config: ${{ fromJson(needs.setup.outputs.platforms) }}

    steps:
      - uses: r-hub/actions/checkout@v1

      - uses: r-hub/actions/setup-r@v1
        with:
          job-config: ${{ matrix.config.job-config }}
          token: ${{ secrets.RHUB_TOKEN }}

      - uses: r-hub/actions/platform-info@v1
        with:
          token: ${{ secrets.RHUB_TOKEN }}
          job-config: ${{ matrix.config.job-config }}

      - uses: r-hub/actions/setup-deps@v1
        with:
          job-config: ${{ matrix.config.job-config }}
          token: ${{ secrets.RHUB_TOKEN }}

      - uses: r-hub/actions/run-check@v1
        with:
          job-config: ${{ matrix.config.job-config }}
          token: ${{ secrets.RHUB_TOKEN }}

      - name: Show install log
        if: always()
        run: find . -name '00install.out' -exec cat {} +
        shell: bash
