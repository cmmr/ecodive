# R-hub's generic GitHub Actions workflow file. It's canonical location is at
# https://github.com/r-hub/actions/blob/v1/workflows/rhub.yaml
# You can update this file to a newer version using the rhub2 package:
#
# rhub::rhub_setup()
#
# It is unlikely that you need to modify this file manually.

name: R-hub
run-name: "${{ github.event.inputs.id }}: ${{ github.event.inputs.name || format('Manually run by {0}', github.triggering_actor) }}"

on:
  workflow_dispatch:
    inputs:
      config:
        description: 'A comma separated list of R-hub platforms to use.'
        type: string
        default: 'linux,windows,macos'
      name:
        description: 'Run name. You can leave this empty now.'
        type: string
      id:
        description: 'Unique ID. You can leave this empty now.'
        type: string

jobs:

  setup:
    runs-on: ubuntu-latest
    outputs:
      containers: ${{ steps.rhub-setup.outputs.containers }}
      platforms: ${{ steps.rhub-setup.outputs.platforms }}

    steps:
    # NO NEED TO CHECKOUT HERE
    - uses: r-hub/actions/setup@v1
      with:
        config: ${{ github.event.inputs.config }}
      id: rhub-setup

  linux-containers:

    needs: setup
    if: ${{ needs.setup.outputs.containers != '[]' }}
    runs-on: ubuntu-latest
    name: ${{ matrix.config.label }}
    strategy:
      fail-fast: false
      matrix:
        config: ${{ fromJson(needs.setup.outputs.containers) }}
    container:
      image: ${{ matrix.config.container }}

    steps:
      - uses: r-hub/actions/checkout@v1
      
      - uses: r-hub/actions/platform-info@v1
        with:
          token: ${{ secrets.RHUB_TOKEN }}
          job-config: ${{ matrix.config.job-config }}

      - uses: r-hub/actions/setup-deps@v1
        with:
          token: ${{ secrets.RHUB_TOKEN }}
          job-config: ${{ matrix.config.job-config }}

      - uses: r-hub/actions/run-check@v1
        with:
          token: ${{ secrets.RHUB_TOKEN }}
          job-config: ${{ matrix.config.job-config }}

      - name: Verify rchk results (Enhanced)
        if: ${{ always() && matrix.config.label == 'rchk' }}
        shell: Rscript {0}
        run: |
          # Define paths used by the r-hub rchk container
          pkg           <- read.dcf("DESCRIPTION", "Package")[[1]]
          libs_dir      <- file.path("/opt/R/devel-rchk/packages/lib", pkg, "libs")
          so_file       <- file.path(libs_dir, paste0(pkg, ".so"))
          bcheck_file   <- file.path(libs_dir, paste0(pkg, ".so.bcheck"))
          maacheck_file <- file.path(libs_dir, paste0(pkg, ".so.maacheck"))

          if (file.exists(so_file)) {
            # Locate maacheck (it is often in /rchk/scripts or /opt/rchk)
            maacheck_bin <- Sys.which("maacheck")
            if (maacheck_bin == "") {
                cat("maacheck not in PATH. Searching...\n")
                # Search common locations or root to find it
                found <- system("find /rchk /opt -name maacheck -type f -executable 2>/dev/null", intern = TRUE)
                if (length(found) > 0) maacheck_bin <- found[1]
            }

            if (length(maacheck_bin) > 0 && maacheck_bin != "") {
                cat("Found maacheck at:", maacheck_bin, "\n")
                cat("Running maacheck on", so_file, "\n")
                
                # Run maacheck and redirect output
                cmd <- paste(maacheck_bin, shQuote(so_file), ">", shQuote(maacheck_file), "2>&1")
                exit_code <- system(cmd)
                
                if (exit_code != 0) cat("Warning: maacheck command returned non-zero exit code\n")
            } else {
                cat("Error: Could not find 'maacheck' executable in container.\n")
            }
          } else {
            stop("Could not find shared object file at: ", so_file)
          }

          errors <- character(0)

          # 1. Check bcheck (generated by the previous run-check step)
          cat("Checking bcheck file:", bcheck_file, "\n")
          if (file.exists(bcheck_file)) {
            b_lines <- readLines(bcheck_file)
            # Filter out known non-error lines
            b_lines <- b_lines[!grepl("too many states", b_lines)]
            b_lines <- b_lines[!grepl("^Analyzed [0-9]+ functions", b_lines)]
            b_lines <- b_lines[!grepl("^==== rchk bcheck", b_lines)]
            if (length(b_lines) > 0) {
               cat("Found bcheck errors:\n")
               print(b_lines)
            }
            errors <- c(errors, b_lines)
          } else {
            cat("WARNING: bcheck file not found! (Did rchk.sh run successfully?)\n")
          }

          # 2. Check maacheck (generated manually above)
          cat("Checking maacheck file:", maacheck_file, "\n")
          if (file.exists(maacheck_file)) {
            m_lines <- readLines(maacheck_file)
            if (length(m_lines) > 0) {
               cat("Found maacheck output:\n")
               print(m_lines)
               errors <- c(errors, m_lines)
            }
          } else {
             cat("WARNING: maacheck file was not generated.\n")
          }

          # 3. Fail if errors exist
          errors <- errors[nzchar(errors)]
          if (length(errors) > 0) {
            stop("rchk failed! Errors detected:\n", paste(errors, collapse = "\n"))
          } else {
            cat("SUCCESS: No memory protection errors found by rchk.\n")
          }

      - name: Show install log
        if: always()
        run: find . -name '00install.out' -exec cat {} +
        shell: bash


  other-platforms:

    needs: setup
    if: ${{ needs.setup.outputs.platforms != '[]' }}
    runs-on: ${{ matrix.config.os }}
    name: ${{ matrix.config.label }}
    strategy:
      fail-fast: false
      matrix:
        config: ${{ fromJson(needs.setup.outputs.platforms) }}

    steps:
      - uses: r-hub/actions/checkout@v1

      - uses: r-hub/actions/setup-r@v1
        with:
          job-config: ${{ matrix.config.job-config }}
          token: ${{ secrets.RHUB_TOKEN }}

      - uses: r-hub/actions/platform-info@v1
        with:
          token: ${{ secrets.RHUB_TOKEN }}
          job-config: ${{ matrix.config.job-config }}

      - uses: r-hub/actions/setup-deps@v1
        with:
          job-config: ${{ matrix.config.job-config }}
          token: ${{ secrets.RHUB_TOKEN }}

      - uses: r-hub/actions/run-check@v1
        with:
          job-config: ${{ matrix.config.job-config }}
          token: ${{ secrets.RHUB_TOKEN }}

      - name: Show install log
        if: always()
        run: find . -name '00install.out' -exec cat {} +
        shell: bash
